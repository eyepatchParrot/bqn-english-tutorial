#!/usr/local/bin/BQN
cpp_xs←⟨-0.9,-0.7,-0.5,-0.3,-0.1,0.1,0.3,0.5,0.7,0.9,-0.9,-0.7,-0.5,-0.3,-0.1,0.1,0.3,0.5,0.7,0.9,-0.9,-0.7,-0.5,-0.3,-0.1,0.1,0.3,0.5,0.7,0.9,-0.9,-0.7,-0.5,-0.3,-0.1,0.1,0.3,0.5,0.7,0.9,-0.9,-0.7,-0.5,-0.3,-0.1,0.1,0.3,0.5,0.7,0.9,-0.9,-0.7,-0.5,-0.3,-0.1,0.1,0.3,0.5,0.7,0.9,-0.9,-0.7,-0.5,-0.3,-0.1,0.1,0.3,0.5,0.7,0.9⟩
cpp_ys←⟨0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143⟩
cpp_xs1←⟨-1.28571,-1,-0.714286,-0.428571,-0.142857,0.142857,0.428571,0.714286,1,1.28571,-1.28571,-1,-0.714286,-0.428571,-0.142857,0.142857,0.428571,0.714286,1,1.28571,-1.28571,-1,-0.714286,-0.428571,-0.142857,0.142857,0.428571,0.714286,1,1.28571,-1.28571,-1,-0.714286,-0.428571,-0.142857,0.142857,0.428571,0.714286,1,1.28571,-1.28571,-1,-0.714286,-0.428571,-0.142857,0.142857,0.428571,0.714286,1,1.28571,-1.28571,-1,-0.714286,-0.428571,-0.142857,0.142857,0.428571,0.714286,1,1.28571,-1.28571,-1,-0.714286,-0.428571,-0.142857,0.142857,0.428571,0.714286,1,1.28571⟩
cpp_ys1←⟨0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.857143,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.571429,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,0.285714,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.285714,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.571429,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143,-0.857143⟩
cpp_dirs_denorm←⟨⟨-0.9,0.857143,-1⟩,⟨-0.7,0.857143,-1⟩,⟨-0.5,0.857143,-1⟩,⟨-0.3,0.857143,-1⟩,⟨-0.1,0.857143,-1⟩,⟨0.1,0.857143,-1⟩,⟨0.3,0.857143,-1⟩,⟨0.5,0.857143,-1⟩,⟨0.7,0.857143,-1⟩,⟨0.9,0.857143,-1⟩,⟨-0.9,0.571429,-1⟩,⟨-0.7,0.571429,-1⟩,⟨-0.5,0.571429,-1⟩,⟨-0.3,0.571429,-1⟩,⟨-0.1,0.571429,-1⟩,⟨0.1,0.571429,-1⟩,⟨0.3,0.571429,-1⟩,⟨0.5,0.571429,-1⟩,⟨0.7,0.571429,-1⟩,⟨0.9,0.571429,-1⟩,⟨-0.9,0.285714,-1⟩,⟨-0.7,0.285714,-1⟩,⟨-0.5,0.285714,-1⟩,⟨-0.3,0.285714,-1⟩,⟨-0.1,0.285714,-1⟩,⟨0.1,0.285714,-1⟩,⟨0.3,0.285714,-1⟩,⟨0.5,0.285714,-1⟩,⟨0.7,0.285714,-1⟩,⟨0.9,0.285714,-1⟩,⟨-0.9,-0,-1⟩,⟨-0.7,-0,-1⟩,⟨-0.5,-0,-1⟩,⟨-0.3,-0,-1⟩,⟨-0.1,-0,-1⟩,⟨0.1,-0,-1⟩,⟨0.3,-0,-1⟩,⟨0.5,-0,-1⟩,⟨0.7,-0,-1⟩,⟨0.9,-0,-1⟩,⟨-0.9,-0.285714,-1⟩,⟨-0.7,-0.285714,-1⟩,⟨-0.5,-0.285714,-1⟩,⟨-0.3,-0.285714,-1⟩,⟨-0.1,-0.285714,-1⟩,⟨0.1,-0.285714,-1⟩,⟨0.3,-0.285714,-1⟩,⟨0.5,-0.285714,-1⟩,⟨0.7,-0.285714,-1⟩,⟨0.9,-0.285714,-1⟩,⟨-0.9,-0.571429,-1⟩,⟨-0.7,-0.571429,-1⟩,⟨-0.5,-0.571429,-1⟩,⟨-0.3,-0.571429,-1⟩,⟨-0.1,-0.571429,-1⟩,⟨0.1,-0.571429,-1⟩,⟨0.3,-0.571429,-1⟩,⟨0.5,-0.571429,-1⟩,⟨0.7,-0.571429,-1⟩,⟨0.9,-0.571429,-1⟩,⟨-0.9,-0.857143,-1⟩,⟨-0.7,-0.857143,-1⟩,⟨-0.5,-0.857143,-1⟩,⟨-0.3,-0.857143,-1⟩,⟨-0.1,-0.857143,-1⟩,⟨0.1,-0.857143,-1⟩,⟨0.3,-0.857143,-1⟩,⟨0.5,-0.857143,-1⟩,⟨0.7,-0.857143,-1⟩,⟨0.9,-0.857143,-1⟩⟩
cpp_dirs_norm←⟨0.626877,0.670448,0.709828,0.740295,0.757078,0.757078,0.740295,0.709828,0.670448,0.626877,0.684141,0.741957,0.796432,0.840208,0.864989,0.864989,0.840208,0.796432,0.741957,0.684141,0.727079,0.797672,0.866578,0.923856,0.95711,0.95711,0.923856,0.866578,0.797672,0.727079,0.743294,0.819232,0.894427,0.957826,0.995037,0.995037,0.957826,0.894427,0.819232,0.743294,0.727079,0.797672,0.866578,0.923856,0.95711,0.95711,0.923856,0.866578,0.797672,0.727079,0.684141,0.741957,0.796432,0.840208,0.864989,0.864989,0.840208,0.796432,0.741957,0.684141,0.626877,0.670448,0.709828,0.740295,0.757078,0.757078,0.740295,0.709828,0.670448,0.626877⟩
cpp_dirs←⟨⟨-0.564189,0.537323,-0.626877⟩,⟨-0.469313,0.574669,-0.670448⟩,⟨-0.354914,0.608424,-0.709828⟩,⟨-0.222089,0.634539,-0.740295⟩,⟨-0.0757078,0.648924,-0.757078⟩,⟨0.0757078,0.648924,-0.757078⟩,⟨0.222089,0.634539,-0.740295⟩,⟨0.354914,0.608424,-0.709828⟩,⟨0.469313,0.574669,-0.670448⟩,⟨0.564189,0.537323,-0.626877⟩,⟨-0.615727,0.390938,-0.684141⟩,⟨-0.51937,0.423975,-0.741957⟩,⟨-0.398216,0.455104,-0.796432⟩,⟨-0.252063,0.480119,-0.840208⟩,⟨-0.0864989,0.494279,-0.864989⟩,⟨0.0864989,0.494279,-0.864989⟩,⟨0.252063,0.480119,-0.840208⟩,⟨0.398216,0.455104,-0.796432⟩,⟨0.51937,0.423975,-0.741957⟩,⟨0.615727,0.390938,-0.684141⟩,⟨-0.654371,0.207737,-0.727079⟩,⟨-0.558371,0.227906,-0.797672⟩,⟨-0.433289,0.247594,-0.866578⟩,⟨-0.277157,0.263959,-0.923856⟩,⟨-0.095711,0.27346,-0.95711⟩,⟨0.095711,0.27346,-0.95711⟩,⟨0.277157,0.263959,-0.923856⟩,⟨0.433289,0.247594,-0.866578⟩,⟨0.558371,0.227906,-0.797672⟩,⟨0.654371,0.207737,-0.727079⟩,⟨-0.668965,-0,-0.743294⟩,⟨-0.573462,-0,-0.819232⟩,⟨-0.447214,-0,-0.894427⟩,⟨-0.287348,-0,-0.957826⟩,⟨-0.0995037,-0,-0.995037⟩,⟨0.0995037,-0,-0.995037⟩,⟨0.287348,-0,-0.957826⟩,⟨0.447214,-0,-0.894427⟩,⟨0.573462,-0,-0.819232⟩,⟨0.668965,-0,-0.743294⟩,⟨-0.654371,-0.207737,-0.727079⟩,⟨-0.558371,-0.227906,-0.797672⟩,⟨-0.433289,-0.247594,-0.866578⟩,⟨-0.277157,-0.263959,-0.923856⟩,⟨-0.095711,-0.27346,-0.95711⟩,⟨0.095711,-0.27346,-0.95711⟩,⟨0.277157,-0.263959,-0.923856⟩,⟨0.433289,-0.247594,-0.866578⟩,⟨0.558371,-0.227906,-0.797672⟩,⟨0.654371,-0.207737,-0.727079⟩,⟨-0.615727,-0.390938,-0.684141⟩,⟨-0.51937,-0.423975,-0.741957⟩,⟨-0.398216,-0.455104,-0.796432⟩,⟨-0.252063,-0.480119,-0.840208⟩,⟨-0.0864989,-0.494279,-0.864989⟩,⟨0.0864989,-0.494279,-0.864989⟩,⟨0.252063,-0.480119,-0.840208⟩,⟨0.398216,-0.455104,-0.796432⟩,⟨0.51937,-0.423975,-0.741957⟩,⟨0.615727,-0.390938,-0.684141⟩,⟨-0.564189,-0.537323,-0.626877⟩,⟨-0.469313,-0.574669,-0.670448⟩,⟨-0.354914,-0.608424,-0.709828⟩,⟨-0.222089,-0.634539,-0.740295⟩,⟨-0.0757078,-0.648924,-0.757078⟩,⟨0.0757078,-0.648924,-0.757078⟩,⟨0.222089,-0.634539,-0.740295⟩,⟨0.354914,-0.608424,-0.709828⟩,⟨0.469313,-0.574669,-0.670448⟩,⟨0.564189,-0.537323,-0.626877⟩⟩
cpp_tcas←⟨11.7226,12.1351,12.422,12.511,12.3404,11.8861,11.1785,10.2925,9.31922,8.33746,12.7934,13.4294,13.9376,14.1995,14.0993,13.5803,12.6871,11.5483,10.3132,9.09907,13.5964,14.4379,15.1651,15.6132,15.6009,15.0266,13.9502,12.5654,11.0876,9.67015,13.8996,14.8281,15.6525,16.1873,16.2191,15.6221,14.4632,12.9692,11.3873,9.88581,13.5964,14.4379,15.1651,15.6132,15.6009,15.0266,13.9502,12.5654,11.0876,9.67015,12.7934,13.4294,13.9376,14.1995,14.0993,13.5803,12.6871,11.5483,10.3132,9.09907,11.7226,12.1351,12.422,12.511,12.3404,11.8861,11.1785,10.2925,9.31922,8.33746⟩
cpp_d2s←⟨127.581,117.739,110.694,108.475,112.715,123.72,140.042,159.064,178.152,195.487,101.328,84.6507,70.7443,63.3736,66.2092,80.5747,104.036,131.638,158.638,182.207,80.1385,56.548,35.0192,21.2291,21.6123,39.2006,70.3912,107.111,142.064,171.488,71.8011,45.1275,20,2.97248,1.94059,20.9505,55.8165,96.8,135.329,167.271,80.1385,56.548,35.0192,21.2291,21.6123,39.2006,70.3912,107.111,142.064,171.488,101.328,84.6507,70.7443,63.3736,66.2092,80.5747,104.036,131.638,158.638,182.207,127.581,117.739,110.694,108.475,112.715,123.72,140.042,159.064,178.152,195.487⟩
cpp_thcs←⟨-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,1.01367,1.43506,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan⟩
cpp_t0s←⟨-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,15.1736,14.784,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan⟩
cpp_t1s←⟨-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,17.2009,17.6542,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan,-nan⟩
cpp_ray_intersects←⟨0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0⟩
cpp_framebuffer←⟨⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.4,0.4,0.3⟩,⟨0.4,0.4,0.3⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩,⟨0.2,0.7,0.8⟩⟩

# Gets ListBegin ListEnd Strand StatementEnd Negative nothing Set
# ←    ⟨         ⟩       ‿      ⋄            ¯        ·       ↩
# 𝔽𝕨𝔾𝕩
⟨ JoinTo, Exponential, Display, pi, Times, Couple, DividedBy, Reciprocal, _scan ⟩ ← ⟨
  ∾,      ⋆,           •Show,   π,  ×,     ≍,      ÷,         ÷,          ` ⟩
⟨ SquareRoot, Root, _swap, _self, _undo, _constant, _atop_, nul, infinity, Power ⟩ ← ⟨
  √,          √,    ˜,     ˜,     ⁼,     ˙,         ∘,      @,   ∞,        ⋆ ⟩
⟨ IdentityL, Identity, Left, Right, Max, Min, Floor, Ceiling ⟩ ← ⟨
  ⊣,         ⊢,        ⊣,    ⊢,     ⌈,   ⌊,   ⌊,     ⌈ ⟩
⟨ _fold, Solo, Reverse, Rotate, _each, Join, Range, _bind_l_, _after_, ⟩ ← ⟨
  ´,     ≍,    ⌽,       ⌽,      ¨,     ∾,    ↕,     ⊸,        ⟜,        ⟩
⟨ _bind_r_, Not, _before_, Negate, _over_, Depth, Rank, Length, NotEquals, NotMatch, Absolute, Match,  ⟩ ← ⟨
  ⟜,        ¬,   ⊸,        -,      ○,      ≡,     =,    ≠,      ≠,         ≢,        |,        ≡,     ⟩
⟨ Drop, Take, _under_, Pick,  ⟩ ← ⟨
  ↓,    ↑,    ⌾,       ⊑,     ⟩
⟨ nl,   Repr,  Out,  Bytes,       _rank_op_, _cells, _insert, Merge, Shape, Assert, Or, Tan,       Transpose, Deshape, Reshape, ⟩ ← ⟨
  @+10, •Repr, •Out, •file.Bytes, ⎉,         ˘,      ˝,       >,     ≢,     !,      ∨,  •math.Tan, ⍉,         ⥊,       ⥊,       ⟩

nan ← Negate 0 DividedBy 0
# Not Less than to handle nan
AbsNear ← Not 1e¯5 < Absolute _atop_ - _over_ Deshape
RelNear ← Not 1e¯5 < Absolute _atop_ - _bind_r_ 1 _atop_ DividedBy _over_ Deshape
Near ← AbsNear Or RelNear
DeVec ← 1 Transpose Merge

origin ← ⟨ 0, 0, 0 ⟩
width ← 10
height ← 7
fov ← pi DividedBy 2
color ← ⟨⟨ 0.2, 0.7, 0.8 ⟩   # background
         ⟨ 0.4, 0.4, 0.3 ⟩⟩  # foreground
sphereCenter ← ⟨ 0-3, 0, 0-16 ⟩
sphereRadius ← 2
vL ← sphereCenter - origin
xs ← - _bindR_ 1 DividedBy _bindR_ width 2 Times 0.5+height‿width Reshape Range width
ys ← Negate - _bindR_ 1 DividedBy _bindR_ height 2 Times 0.5+Transpose width‿height Reshape Range height
xs1 ← xs Times (Tan fov DividedBy 2) Times width DividedBy height
ys1 ← ys Times Tan fov DividedBy 2
dirsDenorm ← xs1 JoinTo ys1 Couple (height‿width Reshape ¯1)
dirsNorm ← Reciprocal SquareRoot + _insert Times _self dirsDenorm
dirs ← Times _bindR_ dirsNorm _rankOp_ (Rank dirsNorm) dirsDenorm 
tcas ← + _insert vL Times dirs
d2s ← vL +_insert _before_ - _after_ Identity _over_ (Times _self) tcas
thcs ← SquareRoot d2s -_swap Times _self sphereRadius
t0s ← tcas - thcs
t1s ← tcas + thcs
ray_intersects ← Not (d2s > Times _self sphereRadius) Or (t0s < 0) Or t1s < 0
framebuffer ← Pick _bindR_ color _each ray_intersects

Display _each ⟨
    Assert _atop_ Times _fold _each ⟨
        xs Near cpp_xs
        ys Near cpp_ys
        xs1 Near cpp_xs1
        ys1 Near cpp_ys1
        dirs_denorm Near DeVec cpp_dirs_denorm
        dirs_norm Near cpp_dirs_norm
        dirs Near DeVec cpp_dirs
        tcas Near cpp_tcas
        d2s Near cpp_d2s
        thcs Near cpp_thcs
        t0s Near cpp_t0s
        t1s Near cpp_t1s
        ray_intersects Near cpp_ray_intersects
        (Merge framebuffer) Near Merge cpp_framebuffer
    ⟩
⟩
header ← "P6" JoinTo nl JoinTo (Repr width) JoinTo ' ' JoinTo (Repr height) JoinTo nl JoinTo "255" JoinTo nl
# "bqn2.ppm" •file.Chars header JoinTo Repr Floor 255 Times 0 Max 1 Min Deshape Merge framebuffer
